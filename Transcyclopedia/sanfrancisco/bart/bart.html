<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcyclopedia San Francisco: Bay Area Rapid Transit</title>
    <link rel="stylesheet" href="bart.css">
    <script src="bart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav id="navbar">
        <a href="#" class="brand">
            <!--<i class="fa-solid fa-earth-americas"></i>-->
            <span id="globe"><i class="fa-solid fa-earth-americas"></i></span>
            <span>Transcyclopedia</span>
        </a>
        <ul class="nav-links">
            <input type="checkbox" id="checkbox_toggle" />
            <label for="checkbox_toggle" class="hamburger">&#9776;</label>
            <div class="menu">
                <li style="--i:0;">
                    <a href="https://dinwun450.github.io/Transcyclopedia/trcypdia_main.html#">
                        <span>Menu</span>
                        <span><ion-icon name="home-outline"></ion-icon></span>
                    </a>
                </li>
                <li style="--i:1;">
                    <a href="#">
                        <span>Agency</span>
                        <span><ion-icon name="business-outline"></ion-icon></span>
                    </a>
                </li>
                <li style="--i:2;">
                    <a href="#">
                        <span>Alerts</span>
                        <span><ion-icon name="warning-outline"></ion-icon></span>
                    </a>
                </li>
                <li style="--i:3;">
                    <a href="#">
                        <span>Lines</span>
                        <span><ion-icon name="map-outline"></ion-icon></span>
                    </a>
                </li>
                <li style="--i:4;">
                    <a href="#">
                        <span>About</span>
                        <span><ion-icon name="information-circle-outline"></ion-icon></span>
                    </a>
                </li>
            </div>
        </ul>
    </nav>
    <div class="main">
        <div class="topfooter"><h1 style="color: white;" id="titleofsection">Bay Area Rapid Transit</h1></div>
        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'info')" id="defaulttab">About BART</button>
            <button class="tablinks" onclick="openTab(event, 'lines')">Lines</button>
            <button class="tablinks" onclick="openTab(event, 'departures')">Departures</button>
        </div>

        <div id="info" class="tabcontent">
            <h2>About BART</h2>
            <p id="about_content">
                Bay Area Rapid Transit (BART) is a rapid transit system serving the San Francisco Bay Area in California. BART serves 50 stations along six routes and 131 miles (211 kilometers) of track, including a 9-mile (14 km) spur line running to Antioch, which uses diesel multiple unit vehicles, and a 3-mile (4.8 km) automated guideway transit line serving Oakland International Airport. With an average of 145,900 weekday passengers as of the first quarter of 2023 and 41,286,400 annual passengers in 2022, BART is the fifth-busiest heavy rail rapid transit system in the United States.<br>
                BART is operated by the San Francisco Bay Area Rapid Transit District which formed in 1957. The initial system opened in stages from 1972 to 1974. The system has been extended several times, most recently in 2020, when Milpitas and Berryessa/North San Jose stations opened as part of the under construction Silicon Valley BART extension in partnership with the Santa Clara Valley Transportation Authority (VTA).
                <a href="https://en.wikipedia.org/wiki/Bay_Area_Rapid_Transit">Wikipedia</a>
            </p>
        </div>
        <div id="lines" class="tabcontent">
            <h2>Lines</h2>
            <ul id="bart_lines">
                <li id="each_line"><div id="line">-</div> <div id="route_desc">(Loading)</div></li>
            </ul>
        </div>
        <div id="departures" class="tabcontent">
            <h2>Departures</h2>
            <input type="text" placeholder="Search for a station.." onkeydown="keyDown()" id="stationgetter" autocomplete="off">
            <p class="headerforstop">Departures for &nbsp;<span id="stationname">---</span></p>
            <ul id="list_of_departures">
                <li id="line_for_departure"><div class="wrapper_for_departure"><div id="line_for_each_departure">-</div> <span id="route_headsign">(None)</span> <span id="route_depart">Enter a specific station by their stop ID</span></div></li>
            </ul>
            <h3>Alerts Today</h3>
            <ul id="list_of_alerts">
                <li id="alert_entity">
                    <p>Once you typed down the station by their ID, the advisories will display here.</p>
                </li>
            </ul>
            <button id="clearall" onclick="clearAll()">Clear</button>
        </div>
    </div>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script>
        let lastScrollTop = 0;
        navbar = document.getElementById("navbar"); 
        window.addEventListener("scroll", function(){
            let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            if (scrollTop > lastScrollTop){
                navbar.classList.add("icon");
            } else {
                navbar.classList.remove("icon");
            }
            lastScrollTop = scrollTop;
        })

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        document.getElementById("defaulttab").click();

        function keyDown(e) {
            e = e || window.event;
            if (e.keyCode === 13) {
                console.log("Here we go!");
                callOver();
            }
        }
        
        function callOver() {
            getValue = document.getElementById("stationgetter").value;
            var departureCall = new XMLHttpRequest();
            departureCall.open("GET", `https://transit.land/api/v2/rest/stops?served_by_onestop_ids=o-9q9-bart&stop_id=${getValue}&api_key=x5unflDSbpKEWnThyfmteM8MHxIsg3eL`);
            departureCall.onreadystatechange = function() {
                if (departureCall.readyState === 4 && departureCall.status === 200) {
                    var stopIdExtraction = JSON.parse(departureCall.responseText);
                    console.log(stopIdExtraction);

                    if (stopIdExtraction.stops.length === 0) {
                        console.log("Nothing to do about it...")
                    }
                    else {
                        var stopCodeSpecified = stopIdExtraction.stops[0].stop_code;
                        var stopName = stopIdExtraction.stops[0].stop_name;
                        console.log(stopCodeSpecified);
                        document.getElementById("stationname").innerHTML = stopName;
                        gatherDepartures(stopCodeSpecified);
                    }
                }
            }
            departureCall.send();
        }

        function gatherDepartures(stopCode) {
            var secondDepartureRequest = new XMLHttpRequest();
            secondDepartureRequest.open("GET", `https://transit.land/api/v2/rest/stops/f-sf~bay~area~rg:${stopCode}/departures?api_key=x5unflDSbpKEWnThyfmteM8MHxIsg3eL&include_alerts=true`);
            secondDepartureRequest.onreadystatechange = function() {
                if (secondDepartureRequest.readyState === 4 && secondDepartureRequest.status === 200) {
                    var compileDepartures = JSON.parse(secondDepartureRequest.responseText);
                    console.log(compileDepartures);

                    for (var i=0; i<compileDepartures.stops[0].departures.length; i++) {
                        var routeColor = compileDepartures.stops[0].departures[i].trip.route.route_color;
                        var routeColorInText = compileDepartures.stops[0].departures[i].trip.route.route_text_color;
                        var routeShort = compileDepartures.stops[0].departures[i].trip.route.route_short_name;
                        var routeLong = compileDepartures.stops[0].departures[i].trip.trip_headsign;
                        var departuredTime = compileDepartures.stops[0].departures[i].arrival.estimated;
                        var scheduledTime = compileDepartures.stops[0].departures[i].arrival.scheduled;

                        if (departuredTime === null) {
                            document.getElementById("route_depart").innerHTML = ` ${scheduledTime} (scheduled)`;
                            document.getElementById("route_depart").style.color = "black";
                        }
                        else if (scheduledTime === null) {
                            continue
                        }
                        else {
                            document.getElementById("route_depart").innerHTML = ` ${departuredTime} <span id="delay">()</span>`;
                            document.getElementById("route_depart").style.color = "darkgreen";
                            
                            if (departuredTime = compileDepartures.stops[0].departures[i].arrival.delay >= 60) {
                                document.getElementById("delay").innerHTML = `(${Math.floor(compileDepartures.stops[0].departures[i].arrival.delay / 60)} min late)`;
                                document.getElementById("delay").style.color = "crimson";
                            }
                            else if (departuredTime = compileDepartures.stops[0].departures[i].arrival.delay === 0) {
                                document.getElementById("delay").innerHTML = `(on time)`;
                                document.getElementById("delay").style.color = "green";
                            }
                            else {
                                document.getElementById("delay").innerHTML = "(no data)";
                                document.getElementById("delay").style.color = "black";
                            }
                        }

                        document.getElementById("line_for_each_departure").innerHTML = routeShort;
                        document.getElementById("line_for_each_departure").style.backgroundColor = `#${routeColor}40`;
                        document.getElementById("line_for_each_departure").style.border = `1px solid #${routeColor}`;
                        document.getElementById("line_for_each_departure").style.color = `#${routeColorInText}`;
                        document.getElementById("route_headsign").innerHTML = routeLong;

                        var departureClone = document.getElementById("line_for_departure");
                        var listToInsertClone = departureClone.cloneNode(true);
                        document.getElementById("list_of_departures").appendChild(listToInsertClone);

                        var alertList_byAgency = compileDepartures.stops[0].departures[i].trip.route.agency.alerts;
                        for (var j = 0; j < alertList_byAgency.length; j++) {
                            if (document.getElementById("alert_entity").textContent === compileDepartures.stops[0].departures[i].trip.route.agency.alerts[j].description_text[0].text) {
                                continue;
                            }
                            document.getElementById("alert_entity").innerHTML = `<p>${alertList_byAgency[j].description_text[0].text}</p>`
                        }
                    }

                    var departuresAll = document.getElementById("list_of_departures").children;
                    document.querySelector("#list_of_departures").removeChild(departuresAll[0]);
                }
            }
            secondDepartureRequest.send();
        }

        function clearAll() {
            document.getElementById("list_of_departures").innerHTML = `
            <li id="line_for_departure"><div class="wrapper_for_departure"><div id="line_for_each_departure">-</div> <span id="route_headsign">(None)</span> <span id="route_depart">Enter a specific station by their stop ID</span></div></li>
            `
            document.getElementById("stationname").innerHTML = "---";
            document.getElementById("alert_entity").innerHTML = `<p>Once you typed down the station by their ID, the advisories will display here.</p>`
        }
    </script>
</body>
</html>
