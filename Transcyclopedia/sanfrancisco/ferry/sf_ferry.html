<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcyclopedia San Francisco: San Francisco Ferries</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="sf_ferry.css">
    <script src="js_assets/sf_ferry_agency.js"></script>
</head>
<body>
    <nav id="navbar">
        <a href="https://dinwun450.github.io/Transcyclopedia/trcypdia_main.html" class="brand">
            <!--<i class="fa-solid fa-earth-americas"></i>-->
            <span id="globe"><i class="fa-solid fa-earth-americas"></i></span>
            <span>Transcyclopedia</span>
        </a>
        <ul class="nav-links">
            <input type="checkbox" id="checkbox_toggle" />
            <label for="checkbox_toggle" class="hamburger">&#9776;</label>
            <div class="menu">
                <li style="--i:0;">
                    <a href="https://dinwun450.github.io/Transcyclopedia/trcypdia_main.html">
                        <span>Menu</span>
                        <span><ion-icon name="home-outline"></ion-icon></span>
                    </a>
                </li>
                <li style="--i:1;">
                    <a href="#">
                        <span>Agency</span>
                        <span><ion-icon name="business-outline"></ion-icon></span>
                    </a>
                </li>
                <li style="--i:2;">
                    <a href="#">
                        <span>Alerts</span>
                        <span><ion-icon name="warning-outline"></ion-icon></span>
                    </a>
                </li>
                <li style="--i:3;">
                    <a href="#">
                        <span>Lines</span>
                        <span><ion-icon name="map-outline"></ion-icon></span>
                    </a>
                </li>
                <li style="--i:4;">
                    <a href="#">
                        <span>About</span>
                        <span><ion-icon name="information-circle-outline"></ion-icon></span>
                    </a>
                </li>
            </div>
        </ul>
    </nav>
    <div class="main">
        <div class="topfooter">
            <h1 style="color: white;" id="titleofsection">SF Ferries</h1>
        </div>
        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'info')" id="defaulttab">Ferry Info</button>
            <button class="tablinks" onclick="openTab(event, 'lines')">Routes</button>
            <button class="tablinks" onclick="openTab(event, 'departures')">Departures</button>
        </div>
        <div id="info" class="tabcontent">
            <h2>Ferry Info</h2>
            <div class="ferryagencies">
                <select name="" id="ferry_agency" onchange="changeAgency(value);">
                    <option value="prompt">Select Ferry Agency</option>
                    <option value="sfbayferry">SF Bay Ferry</option>
                    <option value="ggf">Golden Gate Ferry</option>
                </select>
                <div class="about_agency">
                    <p style="text-align: center; color: white; margin-top: 10px;">Select an Agency from the dropdown menu above.</p>
                </div>
            </div>
        </div>
        <div id="lines" class="tabcontent">
            <h2>Ferry Routes</h2>
            <div class="ferry_agency_routes">
                <select name="" id="ferry_routes" onchange="changeRouteByAgency(value);">
                    <option value="prompt">Select Ferry Agency</option>
                    <option value="sfbayferry">SF Bay Ferry</option>
                    <option value="ggf">Golden Gate Ferry</option>
                </select>
                <ul class="lines">
                    <li id="each_line">
                        <div id="line">-</div>
                        <div id="route_desc">Select a Ferry Agency</div>
                    </li>
                </ul>
            </div>
        </div>
        <div id="departures" class="tabcontent">
            <h2>Departures</h2>
            <select name="" id="ferry_departures" onchange="switchAgency(value);">
                <option value="prompt">Select Ferry Agency</option>
                <option value="sfbayferry">SF Bay Ferry</option>
                <option value="ggf">Golden Gate Ferry</option>
            </select>
            <input type="text" placeholder="Select a Ferry Agency on the top, then search for a ferry terminal..." onkeydown="(new switchAgency()).keydown()" id="terminalgetter" autocomplete="off">
            <p class="headerforstop">Departures for&nbsp;<span id="terminalname">---</span></p>
            <ul id="list_of_departures">
                <li id="line_for_departure">
                    <div class="wrapper_for_departure">
                        <div id="line_for_each_departure">-</div> <div id="route_headsign"><p id="isscroll">(None)</p></div> <span id="route_depart">Enter a specific terminal by their terminal ID</span>
                    </div>
                </li>
            </ul>
            <h3>Alerts Today</h3>
            <ul id="list_of_alerts">
                <li id="alert_entity">
                    <p>Once you typed down the terminal by their ID, the advisories will display here.</p>
                </li>
            </ul>
            <button id="clearall" onclick="clearAllDepartures()">Clear</button>
        </div>
    </div>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script>
        let lastScrollTop = 0;
        var deviceWidth = window.innerWidth;
        var counter = 0;
        var counter_b = 0;
        var counter_c = 0;

        navbar = document.getElementById("navbar");
        window.addEventListener("scroll", function () {
            let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            if (scrollTop > lastScrollTop) {
                navbar.classList.add("icon");
            } else {
                navbar.classList.remove("icon");
            }
            lastScrollTop = scrollTop;
        })

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        document.getElementById("defaulttab").click();

        function switchAgency(d) {
            var agency_ferry = d;
            if (agency_ferry === "sfbayferry") {
                option_agency = "o-9q9p-sanfranciscobayferry"
            }
            else if (agency_ferry === "ggf") {
                option_agency = "o-9q8z-goldengateferry";
            }

            this.keydown = function(e) {
                e = e || window.event;
                if (e.keyCode === 13) {
                    console.log("Enter!")
                    requester(option_agency);
                }
            }

            function requester(operator) {
                var obtainValue = document.getElementById("terminalgetter").value;
                var requestTerminalInfo = new XMLHttpRequest();
                requestTerminalInfo.open("GET", `https://transit.land/api/v2/rest/stops?served_by_onestop_ids=${operator}&stop_id=${obtainValue}&api_key=x5unflDSbpKEWnThyfmteM8MHxIsg3eL`);
                requestTerminalInfo.onreadystatechange = function() {
                    if (requestTerminalInfo.readyState === 4 && requestTerminalInfo.status === 200) {
                        var terminal_id = JSON.parse(requestTerminalInfo.responseText);

                        if (terminal_id.stops.length === 0) {
                            document.getElementById("route_depart").innerHTML = "The terminal ID you keyed in is invalid. <br> For GGF departures, type 'GF:' first, then the terminal ID you're looking for.";
                        }

                        else {
                            var terminal_id_code = terminal_id.stops[0].stop_code;
                            var terminal_name = terminal_id.stops[0].stop_name;

                            if (operator === "o-9q8z-goldengateferry") {
                                terminal_id_code = terminal_id.stops[0].stop_id;
                            }

                            document.getElementById("terminalname").innerHTML = terminal_name;
                            getDepartures(terminal_id_code);
                        }
                    }
                }
                requestTerminalInfo.send();
            }

            function getDepartures(terminal_code) {
                var departureCall = new XMLHttpRequest();
                departureCall.open("GET", `https://transit.land/api/v2/rest/stops/f-sf~bay~area~rg:${terminal_code}/departures?api_key=x5unflDSbpKEWnThyfmteM8MHxIsg3eL&include_alerts=true`);
                departureCall.onreadystatechange = function() {
                    if (departureCall.status === 200 && departureCall.readyState === 4) {
                        var departuresCompiled = JSON.parse(departureCall.responseText);
                        console.log(departuresCompiled);

                        for (var i = 0; i < departuresCompiled.stops[0].departures.length; i++) {
                            var route_color = departuresCompiled.stops[0].departures[i].trip.route.route_color;
                            var route_text_color = departuresCompiled.stops[0].departures[i].trip.route.route_text_color;
                            var route_desc_short = departuresCompiled.stops[0].departures[i].trip.route.route_short_name;
                            var time_realtime = departuresCompiled.stops[0].departures[i].arrival.estimated;
                            var time_scheduled = departuresCompiled.stops[0].departures[i].arrival.scheduled;
                            var headsign_route = departuresCompiled.stops[0].departures[i].trip.trip_headsign;

                            if (time_realtime === null) {
                            document.getElementById("route_depart").innerHTML = ` ${time_scheduled} (scheduled)`;
                            document.getElementById("route_depart").style.color = "black";
                            }
                            else if (time_scheduled === null) {
                                continue;
                            }
                            else {
                                document.getElementById("route_depart").innerHTML = ` ${time_realtime} <span id="delay">()</span>`;
                                document.getElementById("route_depart").style.color = "darkgreen";

                                if (time_realtime = departuresCompiled.stops[0].departures[i].arrival.delay >= 60) {
                                    document.getElementById("delay").innerHTML = `(${Math.floor(departuresCompiled.stops[0].departures[i].arrival.delay / 60)} min late)`;
                                    document.getElementById("delay").style.color = "crimson";
                                }
                                else if (time_realtime = departuresCompiled.stops[0].departures[i].arrival.delay === 0) {
                                    document.getElementById("delay").innerHTML = `(on time)`;
                                    document.getElementById("delay").style.color = "green";
                                }
                                else if (time_realtime = departuresCompiled.stops[0].departures[i].arrival.delay <= 0) {
                                    document.getElementById("delay").innerHTML = `(${Math.abs(Math.floor(departuresCompiled.stops[0].departures[i].arrival.delay / 60))} min early)`;
                                    document.getElementById("delay").style.color = "skyblue";
                                }
                                else {
                                    document.getElementById("delay").innerHTML = "(no data)";
                                    document.getElementById("delay").style.color = "black";
                                }
                            }

                            document.getElementById("line_for_each_departure").innerHTML = route_desc_short;
                            document.getElementById("line_for_each_departure").style.backgroundColor = `#${route_color}40`;
                            document.getElementById("line_for_each_departure").style.border = `1px solid #${route_color}`;
                            document.getElementById("line_for_each_departure").style.color = `#${route_text_color}`;
                            document.getElementById("route_headsign").innerHTML = `<p id="isscroll">${headsign_route}</p>`;

                            if (deviceWidth <= 520 && document.getElementById("route_headsign").innerText.length > 35) {
                                console.log("Scroll?")
                                document.getElementById("isscroll").style.transform = "translateX(200vw)";
                                document.getElementById("isscroll").style.animation = "my-animation-6 10s linear infinite";
                            }

                            var departureClone = document.getElementById("line_for_departure");
                            var listToInsertClone = departureClone.cloneNode(true);
                            document.getElementById("list_of_departures").appendChild(listToInsertClone);

                            var alertList_byAgency = departuresCompiled.stops[0].departures[i].trip.route.agency.alerts;
                            var alertList_byStop = departuresCompiled.stops[0].alerts;

                            for (var j = 0; j < alertList_byAgency.length; j++) {
                                if (counter_b === alertList_byAgency.length) {
                                    break;
                                }
                                document.getElementById("alert_entity").innerHTML = `<p>${alertList_byAgency[j].description_text[0].text}</p>`;
                                console.log(document.getElementById("alert_entity").textContent);

                                var alertClone = document.getElementById("alert_entity");
                                var listToInsertAlertClone = alertClone.cloneNode(true);
                                document.getElementById("list_of_alerts").appendChild(listToInsertAlertClone);
                                console.log(counter);
                                counter_b += 1
                            }

                            for (var k = 0; k < alertList_byStop.length; k++) {
                                if (counter === alertList_byStop.length) {
                                    break;
                                }
                                document.getElementById("alert_entity").innerHTML = `<p>${alertList_byStop[k].description_text[0].text}</p>`;

                                var alertClone = document.getElementById("alert_entity");
                                var listToInsertAlertClone = alertClone.cloneNode(true);
                                document.getElementById("list_of_alerts").appendChild(listToInsertAlertClone);
                                console.log(counter);
                                counter += 1
                            }
                        }
                        var departuresAll = document.getElementById("list_of_departures").children;
                        document.querySelector("#list_of_departures").removeChild(departuresAll[0]);

                        var alertsAll = document.getElementById("list_of_alerts").children;
                        document.querySelector("#list_of_alerts").removeChild(alertsAll[0]);
                    }
                }
                departureCall.send();
            }
        }
        
        function clearAllDepartures() {
            document.getElementById("list_of_departures").innerHTML = `
                <li id="line_for_departure"><div class="wrapper_for_departure"><div id="line_for_each_departure">-</div> <span id="route_headsign">(None)</span> <span id="route_depart">Enter a specific terminal by their stop ID</span></div></li>
            `
            document.getElementById("terminalname").innerHTML = "---";
            document.getElementById("list_of_alerts").innerHTML = "<li id='alert_entity'></li>"
            document.getElementById("alert_entity").innerHTML = `<p>Once you typed down the terminal by their ID, the advisories will display here.</p>`
            counter = 0;
            counter_b = 0;
        }
    </script>
</body>
</html>